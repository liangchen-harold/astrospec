"""
@author: Harold Liang (https://lcsky.org)
"""

import numpy as np
import matplotlib.pyplot as plt
from .utils import print

color_maps = {
    'linear': [i for i in range(256)],
    'orange-enhanced': [[0, 0, 0], [3, 1, 0], [9, 4, 0], [19, 7, 0], [32, 12, 0], [49, 18, 0], [70, 25, 0], [92, 33, 0], [114, 40, 0], [134, 48, 0], [154, 55, 0], [172, 63, 0], [189, 70, 0], [204, 77, 0], [218, 84, 0], [230, 91, 0], [240, 97, 0], [249, 104, 0], [255, 110, 0], [255, 116, 3], [255, 122, 6], [255, 128, 10], [255, 135, 14], [255, 141, 18], [255, 148, 22], [255, 154, 26], [255, 160, 31], [255, 166, 35], [255, 172, 39], [255, 178, 44], [255, 183, 47], [255, 188, 51], [255, 193, 55], [255, 197, 59], [255, 202, 62], [255, 206, 65], [255, 209, 68], [255, 213, 71], [255, 216, 73], [255, 219, 76], [255, 221, 78], [255, 224, 80], [255, 226, 81], [255, 228, 83], [255, 229, 84], [255, 231, 85], [255, 232, 86], [255, 233, 87], [255, 234, 88], [255, 235, 89], [255, 236, 89], [255, 236, 89], [255, 237, 90], [255, 237, 90], [255, 237, 90], [255, 237, 90], [255, 237, 90], [255, 237, 90], [255, 236, 90], [255, 236, 89], [255, 235, 89], [255, 235, 88], [255, 234, 88], [255, 233, 87], [255, 233, 87], [255, 232, 86], [255, 231, 85], [255, 229, 84], [255, 228, 83], [255, 227, 82], [255, 226, 81], [255, 224, 80], [255, 223, 79], [255, 221, 77], [255, 219, 76], [255, 218, 75], [255, 216, 73], [255, 214, 72], [255, 212, 70], [255, 210, 68], [255, 208, 67], [255, 205, 65], [255, 203, 63], [255, 201, 61], [255, 198, 59], [255, 196, 58], [255, 193, 56], [255, 191, 54], [255, 188, 52], [255, 186, 50], [255, 183, 48], [255, 180, 46], [255, 178, 44], [255, 175, 41], [255, 172, 39], [255, 169, 37], [255, 167, 35], [255, 164, 33], [255, 161, 31], [255, 158, 29], [255, 155, 27], [255, 153, 25], [255, 150, 24], [255, 147, 22], [255, 144, 20], [255, 142, 18], [255, 139, 16], [255, 136, 15], [255, 134, 13], [255, 131, 12], [255, 129, 10], [255, 126, 9], [255, 124, 7], [255, 121, 6], [255, 119, 5], [255, 117, 4], [255, 115, 2], [255, 112, 1], [255, 110, 1], [254, 108, 0], [252, 106, 0], [250, 104, 0], [248, 102, 0], [245, 101, 0], [242, 99, 0], [239, 97, 0], [237, 95, 0], [234, 93, 0], [230, 91, 0], [227, 89, 0], [224, 87, 0], [221, 86, 0], [217, 84, 0], [214, 82, 0], [211, 80, 0], [207, 79, 0], [204, 77, 0], [200, 75, 0], [197, 74, 0], [194, 72, 0], [190, 71, 0], [187, 69, 0], [183, 68, 0], [180, 66, 0], [177, 65, 0], [173, 63, 0], [170, 62, 0], [166, 60, 0], [163, 59, 0], [160, 58, 0], [157, 57, 0], [153, 55, 0], [150, 54, 0], [147, 53, 0], [144, 52, 0], [141, 50, 0], [138, 49, 0], [135, 48, 0], [132, 47, 0], [129, 46, 0], [126, 45, 0], [123, 44, 0], [121, 43, 0], [118, 42, 0], [115, 41, 0], [113, 40, 0], [110, 39, 0], [108, 38, 0], [105, 37, 0], [102, 36, 0], [100, 35, 0], [98, 35, 0], [95, 34, 0], [93, 33, 0], [91, 32, 0], [89, 31, 0], [86, 31, 0], [84, 30, 0], [82, 29, 0], [80, 28, 0], [78, 28, 0], [76, 27, 0], [74, 26, 0], [72, 26, 0], [70, 25, 0], [68, 24, 0], [67, 24, 0], [65, 23, 0], [63, 23, 0], [61, 22, 0], [60, 21, 0], [58, 21, 0], [57, 20, 0], [55, 20, 0], [53, 19, 0], [52, 19, 0], [51, 18, 0], [49, 18, 0], [48, 17, 0], [46, 17, 0], [45, 16, 0], [44, 16, 0], [42, 15, 0], [41, 15, 0], [40, 15, 0], [39, 14, 0], [37, 14, 0], [36, 13, 0], [35, 13, 0], [34, 12, 0], [33, 12, 0], [32, 12, 0], [31, 11, 0], [30, 11, 0], [29, 11, 0], [28, 10, 0], [27, 10, 0], [26, 10, 0], [25, 9, 0], [24, 9, 0], [23, 9, 0], [22, 8, 0], [21, 8, 0], [20, 8, 0], [19, 7, 0], [18, 7, 0], [18, 7, 0], [17, 7, 0], [16, 6, 0], [15, 6, 0], [15, 6, 0], [14, 5, 0], [13, 5, 0], [12, 5, 0], [12, 5, 0], [11, 4, 0], [10, 4, 0], [10, 4, 0], [9, 4, 0], [8, 3, 0], [8, 3, 0], [7, 3, 0], [7, 3, 0], [6, 2, 0], [6, 2, 0], [5, 2, 0], [4, 2, 0], [4, 2, 0], [3, 1, 0], [3, 1, 0], [2, 1, 0], [2, 1, 0], [1, 1, 0], [1, 0, 0], [0, 0, 0], [0, 0, 0]],
    'enhanced': [0, 3, 8, 14, 22, 31, 40, 50, 58, 67, 75, 82, 89, 96, 103, 110, 116, 122, 128, 134, 140, 145, 151, 156, 161, 166, 170, 175, 179, 183, 187, 191, 194, 198, 201, 204, 207, 210, 213, 215, 217, 219, 221, 223, 225, 226, 227, 228, 229, 230, 231, 231, 232, 232, 232, 232, 232, 232, 231, 231, 230, 230, 229, 228, 228, 227, 226, 225, 224, 222, 221, 220, 219, 217, 216, 214, 213, 211, 209, 208, 206, 204, 202, 201, 199, 197, 195, 193, 191, 189, 187, 185, 183, 181, 179, 177, 175, 173, 171, 169, 167, 164, 162, 160, 158, 156, 154, 152, 150, 148, 146, 143, 141, 139, 137, 135, 133, 131, 129, 127, 125, 123, 121, 119, 117, 116, 114, 112, 110, 108, 106, 105, 103, 101, 100, 98, 96, 95, 93, 91, 90, 88, 87, 85, 84, 83, 81, 80, 78, 77, 76, 74, 73, 72, 71, 69, 68, 67, 66, 65, 63, 62, 61, 60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50, 49, 48, 47, 46, 45, 45, 44, 43, 42, 41, 40, 40, 39, 38, 37, 36, 36, 35, 34, 33, 33, 32, 31, 31, 30, 29, 29, 28, 27, 27, 26, 25, 25, 24, 24, 23, 22, 22, 21, 21, 20, 20, 19, 18, 18, 17, 17, 16, 16, 15, 15, 14, 14, 13, 13, 12, 12, 11, 11, 10, 10, 9, 9, 8, 8, 7, 7, 6, 6, 5, 5, 5, 4, 4, 3, 3, 2, 2, 1, 1, 0, 0],
}

def color_map(img, map_name = 'orange-enhanced', verbose = 0):
    _map = color_maps[map_name]
    if verbose > 1:
        plt.plot(_map)
        plt.show()

    # slower
    # _map = np.array(_map)
    # _func = np.vectorize(lambda x: _map[x], signature='()->(3)')
    # return _func(img)

    # faster
    return np.array([[_map[item] for item in row] for row in img])

def normalize(img, brightness=1.0, verbose=0):
    # 方法一：主体部分亮度均衡
    n, e = np.histogram(img, bins=100)
    if verbose > 1:
        plt.plot(n[20:])
        plt.show()
    med_idx = np.argsort(n[20:])[::-1] + 20
    # 直方图最高的3箱
    idx_a = min(med_idx[:3])
    idx_b = min(max(med_idx[:3])+1, len(e)-1)
    med_val_a = e[idx_a]
    med_val_b = e[idx_b]
    # 直方图最高的3箱像素均值
    med_val = np.mean(img[(img>med_val_a) & (img<med_val_b)])
    # print(med_idx[:3], idx_a, idx_b)
    # print(med_val)
    img = np.clip(img/med_val*152*brightness, 0, 255)

    # 方法二：按最亮的0.001部分归一化
    # val_max = np.quantile(img, 0.999) * 1.2
    # img = np.clip(img/val_max*255, 0, 255)

    if verbose > 0:
        print(f'overflow = {len(img[img==255]) / len(np.reshape(img, -1)) * 100:.3f}%')
    # img[img==255] = 0

    # n, e = np.histogram(img, bins=100)
    # med_idx = np.argmax(n[20:]) + 20
    # med_val = e[med_idx]
    # print(f'med_val = {med_val:.3f}')
    # plt.plot(n[20:])
    # plt.show()
    return img
